#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"aliases":[],"languageName":"csharp","name":"csharp"}]}}

#!markdown

# Power Platform Notebook - Admininstration - Reset, Restore and Clean an Environment

**Goal:** Reset, Restore and Clean a Power Platform / Dataverse environment to continue the work from a reference environment.

#!markdown

## Prerequisites check

### Power Platform CLI

#!pwsh

# Power Platform CLI -https://learn.microsoft.com/en-us/power-platform/developer/cli/introduction
Write-Host "Checking if Power Platform CLI is installed..." -ForegroundColor Green

try {
    $powerPlatformCliVersion = pac help
} catch {
    Write-Host "Power Platform CLI does not seem installed. Installing..." -ForegroundColor Blue
    dotnet tool install --global Microsoft.PowerApps.CLI.Tool
}

Write-Host "👍🏼 Power Platform CLI is installed!" -ForegroundColor Green

#!markdown

### NuGet packages and namespaces

> Specified version of "Microsoft.PowerPlatform.Dataverse.Client" due to a 'Could not load file or assembly System.ServiceModel.Primitives' error when trying to connect using more recent versions.

#!csharp

// Define NuGet source
#i "nuget:https://api.nuget.org/v3/index.json"

// Import latest version of NuGet packages
#r "nuget:Microsoft.PowerPlatform.Dataverse.Client, 1.0.39"
#r "nuget:Microsoft.Xrm.Sdk"
#r "nuget:System.ServiceModel.Primitives"

// Namespaces to work with Power Platform / Dataverse
using Microsoft.PowerPlatform.Dataverse.Client;
using Microsoft.Crm.Sdk.Messages;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Query;

// Other namespaces
using System.ServiceModel;

#!markdown

## Set variables and connections

### URL of the environment to reset, restore and clean

#!csharp

// Input prompt to get the URL of the environment to reset, restore and clean
string targetedEnvironmentUrl = await GetInputAsync("Please enter the full URL of the environment to reset, restore and clean.");

#!pwsh

# Propagate the URL of the environment to reset, restore and clean to PowerShell
#!set --name targetedEnvironmentUrl --value @csharp:targetedEnvironmentUrl

#!markdown

### URL of the source environment for the backup restore

#!csharp

// Input prompt to get the URL of the source environment for the backup restore
string sourceEnvironmentUrl = await GetInputAsync("Please enter the full URL of the source environment for the backup restore.");

#!pwsh

# Propagate the URL of the source environment for the backup restore to PowerShell
#!set --name sourceEnvironmentUrl --value @csharp:sourceEnvironmentUrl

#!markdown

### Connection to Power Platform CLI

#!pwsh

# Power Platform CLI authentication
Write-Host "Creating a profile of kind ADMIN..." -ForegroundColor Blue

pac auth create --deviceCode --kind ADMIN

Write-Host "👍🏼 Connected to Power Platform CLI!" -ForegroundColor Green

#!markdown

### Connection to Microsoft.PowerPlatform.Dataverse.Client

> ⚠️ Unfortunately, this part currently does not work from GitHub Codespaces.

#!csharp

// Initialize a connection (service client) for the considered environment
string connectionString = $"Url={targetedEnvironmentUrl};RedirectUri=http://localhost;LoginPrompt=Auto;AuthType=OAuth";

ServiceClient serviceClient = new ServiceClient(connectionString);

#!markdown

## Refresh of the considered environment

### Reset environment

#!pwsh

# Reset the considered environment
Write-Host "Start of the reset of the '$targetedEnvironmentUrl' environment..." -ForegroundColor Green

pac admin reset --environment $targetedEnvironmentUrl --async

Write-Host "👍🏼 Reset operation completed!" -ForegroundColor Green

#!pwsh

# Montior the status of the reset operation previously launched
pac admin status

#!markdown

### Restore environment

> In this operation, we will restore the latest system backup of the source environment into the targeted one.

#!pwsh

# Restore the targeted environment with the latest backup from the source environment
Write-Host "Start of the restore of the '$targetedEnvironmentUrl' environment from a backup of the '$sourceEnvironmentUrl' environment..." -ForegroundColor Green

pac admin restore --selected-backup latest --source-env $sourceEnvironmentUrl --target-env $targetedEnvironmentUrl --async

Write-Host "👍🏼 Restore operation completed!" -ForegroundColor Green

#!pwsh

# Montior the status of the reset operation previously launched
pac admin status
